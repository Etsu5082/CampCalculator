# 合宿費用計算アプリ データベース設計書

## 1. ER図（概念）

```
┌─────────────┐       ┌─────────────────┐       ┌─────────────────┐
│   camps     │──────<│   time_slots    │       │   expenses      │
│   (合宿)    │ 1   * │ (タイムスロット) │       │   (費用項目)    │
└─────────────┘       └─────────────────┘       └─────────────────┘
      │                       │                         │
      │ 1                     │                         │
      │                       │ *                       │ 1
      ▼ *                     ▼                         ▼ *
┌─────────────┐       ┌─────────────────┐       ┌─────────────────┐
│ participants│──────<│participant_slots│       │ expense_targets │
│  (参加者)   │ 1   * │ (参加スロット)   │       │(費用対象者設定) │
└─────────────┘       └─────────────────┘       └─────────────────┘
      │
      │ 1
      ▼ *
┌─────────────┐
│meal_adjusts │
│ (食事調整)  │
└─────────────┘
```

---

## 2. テーブル定義

### 2.1 camps（合宿）

| カラム名 | 型 | NULL | 説明 |
|----------|-----|------|------|
| id | INT | NO | 主キー、AUTO_INCREMENT |
| name | VARCHAR(100) | NO | 合宿名（例：2024年度春合宿） |
| start_date | DATE | NO | 開始日 |
| end_date | DATE | NO | 終了日 |
| nights | INT | NO | 泊数 |
| lodging_fee_per_night | INT | NO | 1泊あたり宿泊費（3食付き） |
| breakfast_add_price | INT | NO | 朝食追加時の単価 |
| breakfast_remove_price | INT | NO | 朝食欠食時の減額 |
| lunch_add_price | INT | NO | 昼食追加時の単価 |
| lunch_remove_price | INT | NO | 昼食欠食時の減額 |
| dinner_add_price | INT | NO | 夕食追加時の単価 |
| dinner_remove_price | INT | NO | 夕食欠食時の減額 |
| insurance_fee | INT | NO | 保険料（1人あたり固定） |
| hot_spring_tax | INT | NO | 入湯税（1泊あたり、デフォルト:150） |
| court_fee_per_unit | INT | YES | コート1面あたり料金 |
| gym_fee_per_unit | INT | YES | 体育館1コマあたり料金 |
| banquet_fee_per_person | INT | YES | 宴会場1人あたり料金 |
| first_day_lunch_included | TINYINT(1) | NO | 1日目昼食が費用計算対象か（デフォルト:0=対象外） |
| bus_fee_round_trip | INT | YES | バス往復料金（総額） |
| bus_fee_separate | TINYINT(1) | NO | 往路/復路別設定フラグ（デフォルト:0=往復一括） |
| bus_fee_outbound | INT | YES | 往路バス代（総額）※別設定時のみ使用 |
| bus_fee_return | INT | YES | 復路バス代（総額）※別設定時のみ使用 |
| highway_fee_outbound | INT | YES | 往路高速代（総額） |
| highway_fee_return | INT | YES | 復路高速代（総額） |
| use_rental_car | TINYINT(1) | NO | レンタカーオプション使用フラグ（デフォルト:0=使用しない） |
| rental_car_fee | INT | YES | レンタカー料金（総額） |
| rental_car_highway_fee | INT | YES | レンタカー高速代（総額） |
| rental_car_capacity | INT | YES | レンタカー定員 |
| created_at | DATETIME | NO | 作成日時 |
| updated_at | DATETIME | NO | 更新日時 |

```sql
CREATE TABLE camps (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    start_date DATE NOT NULL,
    end_date DATE NOT NULL,
    nights INT NOT NULL,
    lodging_fee_per_night INT NOT NULL DEFAULT 0,
    breakfast_add_price INT NOT NULL DEFAULT 0,
    breakfast_remove_price INT NOT NULL DEFAULT 0,
    lunch_add_price INT NOT NULL DEFAULT 0,
    lunch_remove_price INT NOT NULL DEFAULT 0,
    dinner_add_price INT NOT NULL DEFAULT 0,
    dinner_remove_price INT NOT NULL DEFAULT 0,
    insurance_fee INT NOT NULL DEFAULT 0,
    hot_spring_tax INT NOT NULL DEFAULT 150,
    court_fee_per_unit INT DEFAULT NULL,
    gym_fee_per_unit INT DEFAULT NULL,
    banquet_fee_per_person INT DEFAULT NULL,
    first_day_lunch_included TINYINT(1) NOT NULL DEFAULT 0,
    bus_fee_round_trip INT DEFAULT NULL,
    bus_fee_separate TINYINT(1) NOT NULL DEFAULT 0,
    bus_fee_outbound INT DEFAULT NULL,
    bus_fee_return INT DEFAULT NULL,
    highway_fee_outbound INT DEFAULT NULL,
    highway_fee_return INT DEFAULT NULL,
    use_rental_car TINYINT(1) NOT NULL DEFAULT 0,
    rental_car_fee INT DEFAULT NULL,
    rental_car_highway_fee INT DEFAULT NULL,
    rental_car_capacity INT DEFAULT NULL,
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

#### バス料金の設定方式
- **bus_fee_separate = 0**（デフォルト）: `bus_fee_round_trip`の金額を往復利用者で割り勘
- **bus_fee_separate = 1**: `bus_fee_outbound`と`bus_fee_return`をそれぞれ利用者で割り勘

#### レンタカーオプション
- **use_rental_car = 1**の場合、レンタカー関連フィールドが有効
- 参加者ごとに`use_rental_car`フラグで利用を選択

#### コート料金の計算
- `court_fee_per_unit`に1面あたりの料金を設定
- 各タイムスロットで使用面数（`court_count`）を指定
- コート料金 = `court_fee_per_unit` × `court_count`

#### 体育館料金の計算
- `gym_fee_per_unit`に1コマあたりの料金を設定
- 日程設定で`activity_type='gym'`を選択したスロットに自動適用
- 体育館の場合は面数指定なし（1コマ単位）

#### 宴会場料金の計算
- `banquet_fee_per_person`に1人あたりの料金を設定
- 日程設定で`activity_type='banquet'`を選択したスロットに自動適用
- 宴会場は1人あたり単価（他の施設利用料とは異なり、参加人数に応じた計算）

---

### 2.2 time_slots（タイムスロット）

合宿の日程を管理。各日の午前・午後・宴会などの活動を定義。

| カラム名 | 型 | NULL | 説明 |
|----------|-----|------|------|
| id | INT | NO | 主キー |
| camp_id | INT | NO | 外部キー → camps.id |
| day_number | INT | NO | 何日目（1, 2, 3, 4...） |
| slot_type | ENUM | NO | 'outbound', 'morning', 'afternoon', 'banquet', 'return' |
| activity_type | ENUM | YES | 'tennis', 'gym', 'banquet', 'bus', NULL |
| facility_fee | INT | YES | 施設利用料（このコマの総額） |
| court_count | INT | YES | 使用コート面数（デフォルト:1） |
| description | VARCHAR(200) | YES | 備考 |

```sql
CREATE TABLE time_slots (
    id INT AUTO_INCREMENT PRIMARY KEY,
    camp_id INT NOT NULL,
    day_number INT NOT NULL,
    slot_type ENUM('outbound', 'morning', 'afternoon', 'banquet', 'return') NOT NULL,
    activity_type ENUM('tennis', 'gym', 'banquet', 'bus') DEFAULT NULL,
    facility_fee INT DEFAULT NULL,
    court_count INT DEFAULT 1,
    description VARCHAR(200) DEFAULT NULL,
    FOREIGN KEY (camp_id) REFERENCES camps(id) ON DELETE CASCADE,
    UNIQUE KEY unique_slot (camp_id, day_number, slot_type)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

---

### 2.3 participants（参加者）

| カラム名 | 型 | NULL | 説明 |
|----------|-----|------|------|
| id | INT | NO | 主キー |
| camp_id | INT | NO | 外部キー → camps.id |
| name | VARCHAR(50) | NO | 氏名 |
| grade | TINYINT | YES | 学年（1,2,3=学年、0=OBOG、NULL=未設定） |
| gender | ENUM | YES | 性別（'male', 'female', NULL=未設定） |
| join_day | INT | NO | 参加開始日（何日目） |
| join_timing | ENUM | NO | 参加タイミング |
| leave_day | INT | NO | 離脱日（何日目） |
| leave_timing | ENUM | NO | 離脱タイミング |
| use_outbound_bus | TINYINT(1) | NO | 往路バス利用 |
| use_return_bus | TINYINT(1) | NO | 復路バス利用 |
| use_rental_car | TINYINT(1) | NO | レンタカー利用（デフォルト:0=使用しない） |
| created_at | DATETIME | NO | 作成日時 |

```sql
CREATE TABLE participants (
    id INT AUTO_INCREMENT PRIMARY KEY,
    camp_id INT NOT NULL,
    name VARCHAR(50) NOT NULL,
    grade TINYINT DEFAULT NULL COMMENT '学年: 1,2,3=学年, 0=OBOG',
    gender ENUM('male', 'female') DEFAULT NULL,
    join_day INT NOT NULL DEFAULT 1,
    join_timing ENUM('outbound_bus', 'morning', 'lunch', 'afternoon', 'dinner', 'night') NOT NULL DEFAULT 'outbound_bus',
    leave_day INT NOT NULL,
    leave_timing ENUM('morning', 'after_breakfast', 'lunch', 'after_lunch', 'afternoon', 'dinner', 'night', 'return_bus') NOT NULL DEFAULT 'return_bus',
    use_outbound_bus TINYINT(1) NOT NULL DEFAULT 1,
    use_return_bus TINYINT(1) NOT NULL DEFAULT 1,
    use_rental_car TINYINT(1) NOT NULL DEFAULT 0,
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (camp_id) REFERENCES camps(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

#### grade（学年）の定義
| 値 | 意味 |
|----|------|
| NULL | 未設定 |
| 0 | OBOG |
| 1 | 1年生 |
| 2 | 2年生 |
| 3 | 3年生 |
| 4 | 4年生 |

#### gender（性別）の定義
| 値 | 意味 |
|----|------|
| NULL | 未設定 |
| male | 男性 |
| female | 女性 |

#### join_timing の定義
| 値 | 意味 | 食事影響 |
|----|------|----------|
| outbound_bus | 往路バスから（1日目のみ） | 通常 |
| morning | 午前から | 通常 |
| lunch | 昼食から | 昼食追加 |
| afternoon | 昼食後（午後）から | 通常 |
| dinner | 夕食から | 夕食欠食なし |
| night | 夕食後から | 夕食欠食 |

#### leave_timing の定義
| 値 | 意味 | 食事影響 |
|----|------|----------|
| morning | 午前活動前 | 朝食後すぐ |
| after_breakfast | 朝食後 | 通常 |
| lunch | 昼食まで | 通常 |
| after_lunch | 昼食後 | 通常（標準） |
| afternoon | 午後活動後 | 通常 |
| dinner | 夕食まで | 通常 |
| night | 夕食後 | 通常 |
| return_bus | 復路バスまで（最終日のみ） | 通常 |

---

### 2.4 participant_slots（参加者×スロット）

参加者がどのスロットに参加するかを管理（自動生成 + 手動調整可能）

| カラム名 | 型 | NULL | 説明 |
|----------|-----|------|------|
| id | INT | NO | 主キー |
| participant_id | INT | NO | 外部キー → participants.id |
| time_slot_id | INT | NO | 外部キー → time_slots.id |
| is_attending | TINYINT(1) | NO | 参加するかどうか |

```sql
CREATE TABLE participant_slots (
    id INT AUTO_INCREMENT PRIMARY KEY,
    participant_id INT NOT NULL,
    time_slot_id INT NOT NULL,
    is_attending TINYINT(1) NOT NULL DEFAULT 1,
    FOREIGN KEY (participant_id) REFERENCES participants(id) ON DELETE CASCADE,
    FOREIGN KEY (time_slot_id) REFERENCES time_slots(id) ON DELETE CASCADE,
    UNIQUE KEY unique_participant_slot (participant_id, time_slot_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

---

### 2.5 meal_adjustments（食事調整）

参加タイミングによる食事の追加・欠食を管理

| カラム名 | 型 | NULL | 説明 |
|----------|-----|------|------|
| id | INT | NO | 主キー |
| participant_id | INT | NO | 外部キー → participants.id |
| day_number | INT | NO | 何日目 |
| meal_type | ENUM | NO | 'breakfast', 'lunch', 'dinner' |
| adjustment_type | ENUM | NO | 'add'（追加）, 'remove'（欠食） |

```sql
CREATE TABLE meal_adjustments (
    id INT AUTO_INCREMENT PRIMARY KEY,
    participant_id INT NOT NULL,
    day_number INT NOT NULL,
    meal_type ENUM('breakfast', 'lunch', 'dinner') NOT NULL,
    adjustment_type ENUM('add', 'remove') NOT NULL,
    FOREIGN KEY (participant_id) REFERENCES participants(id) ON DELETE CASCADE,
    UNIQUE KEY unique_meal_adj (participant_id, day_number, meal_type)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

---

### 2.6 expenses（その他費用・雑費）

| カラム名 | 型 | NULL | 説明 |
|----------|-----|------|------|
| id | INT | NO | 主キー |
| camp_id | INT | NO | 外部キー → camps.id |
| name | VARCHAR(100) | NO | 費用名（例：ボール代、備品代） |
| amount | INT | NO | 金額（総額） |
| target_type | ENUM | NO | 対象者タイプ |
| target_day | INT | YES | 対象日（target_type='slot'の場合） |
| target_slot | ENUM | YES | 対象スロット（target_type='slot'の場合） |
| payer_id | INT | YES | 建て替え者（外部キー → participants.id） |

```sql
CREATE TABLE expenses (
    id INT AUTO_INCREMENT PRIMARY KEY,
    camp_id INT NOT NULL,
    name VARCHAR(100) NOT NULL,
    amount INT NOT NULL,
    target_type ENUM('all', 'slot') NOT NULL DEFAULT 'all',
    target_day INT DEFAULT NULL,
    target_slot ENUM('morning', 'afternoon', 'banquet', 'night') DEFAULT NULL,
    payer_id INT DEFAULT NULL,
    FOREIGN KEY (camp_id) REFERENCES camps(id) ON DELETE CASCADE,
    FOREIGN KEY (payer_id) REFERENCES participants(id) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

#### target_type の説明
- **all**: 全参加者で均等割り
- **slot**: 指定した日のスロットにいた人で均等割り

#### payer_id（建て替え者）
- 費用を建て替えた参加者のID
- NULL: 建て替え者未指定（宿に直接支払い等）
- 建て替え総額の集計に使用

---

### 2.7 settings（システム設定）

| カラム名 | 型 | NULL | 説明 |
|----------|-----|------|------|
| id | INT | NO | 主キー |
| setting_key | VARCHAR(50) | NO | 設定キー |
| setting_value | TEXT | NO | 設定値 |

```sql
CREATE TABLE settings (
    id INT AUTO_INCREMENT PRIMARY KEY,
    setting_key VARCHAR(50) NOT NULL UNIQUE,
    setting_value TEXT NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 初期データ（パスワード）
INSERT INTO settings (setting_key, setting_value) VALUES ('password', 'ハッシュ化されたパスワード');
```

---

## 3. インデックス設計

```sql
-- 検索性能向上のためのインデックス
CREATE INDEX idx_time_slots_camp ON time_slots(camp_id);
CREATE INDEX idx_participants_camp ON participants(camp_id);
CREATE INDEX idx_participant_slots_participant ON participant_slots(participant_id);
CREATE INDEX idx_expenses_camp ON expenses(camp_id);
```

---

## 4. 計算ロジック概要

### 4.1 参加者の負担額計算

```
参加者の負担額 =
    + 宿泊費 × 宿泊数
    + 保険料（固定）
    + 食事調整額（追加 - 欠食）
    + バス代（往復一括 or 往路/復路別）÷ 利用者数（バス利用の場合）
    + 往路高速代 ÷ 往路利用者数（往路バス利用する場合）
    + 復路高速代 ÷ 復路利用者数（復路バス利用する場合）
    + レンタカー代 ÷ レンタカー利用者数（レンタカー利用の場合）
    + レンタカー高速代 ÷ レンタカー利用者数（レンタカー利用の場合）
    + Σ(施設利用料)
        - テニスコート: (単価×面数) ÷ 該当コマ参加者数
        - 体育館: 単価 ÷ 該当コマ参加者数
        - 宴会場: 単価（1人あたり、割り勘なし）
        - その他: 料金 ÷ 該当コマ参加者数
    + Σ(雑費 ÷ 対象者数)
```

#### バス代の計算方式
- **往復一括設定時**（bus_fee_separate = 0）:
  - 往路・復路両方利用する人: `bus_fee_round_trip ÷ 往復利用者数`
  - 往路のみ利用: `bus_fee_round_trip ÷ 2 ÷ 往路利用者数`
  - 復路のみ利用: `bus_fee_round_trip ÷ 2 ÷ 復路利用者数`

- **往路/復路別設定時**（bus_fee_separate = 1）:
  - 往路利用: `bus_fee_outbound ÷ 往路利用者数`
  - 復路利用: `bus_fee_return ÷ 復路利用者数`

### 4.2 宿泊数の計算

```
宿泊数 = leave_day - join_day
※ただし join_timing が 'night' の場合は、その日の宿泊はカウントしない場合あり
```

---

## 5. データ例

### 5.1 合宿データ
```sql
INSERT INTO camps (name, start_date, end_date, nights, lodging_fee_per_night,
                   breakfast_add_price, breakfast_remove_price,
                   lunch_add_price, lunch_remove_price,
                   dinner_add_price, dinner_remove_price,
                   insurance_fee, first_day_lunch_included,
                   bus_fee_outbound, bus_fee_return, highway_fee_outbound, highway_fee_return)
VALUES ('2024年度春合宿', '2024-03-20', '2024-03-23', 3, 8000,
        600, 400,   -- 朝食: 追加+600円、欠食-400円
        990, 440,   -- 昼食: 追加+990円、欠食-440円
        1200, 800,  -- 夕食: 追加+1200円、欠食-800円
        500, 0,     -- 保険料500円、1日目昼食は対象外
        80000, 80000, 15000, 15000);
```

### 5.2 タイムスロットデータ（3泊4日の例）
```sql
INSERT INTO time_slots (camp_id, day_number, slot_type, activity_type, facility_fee, description) VALUES
-- 1日目
(1, 1, 'outbound', 'bus', NULL, 'バス移動（往路）'),
(1, 1, 'afternoon', 'tennis', 5000, 'テニスコート'),
(1, 1, 'banquet', 'banquet', 10000, '夜企画（宴会場）'),

-- 2日目
(1, 2, 'morning', 'tennis', 5000, 'テニスコート'),
(1, 2, 'afternoon', 'gym', 3000, '体育館企画'),

-- 3日目
(1, 3, 'morning', 'tennis', 5000, 'テニスコート'),
(1, 3, 'afternoon', 'tennis', 5000, 'テニスコート'),

-- 4日目
(1, 4, 'morning', 'tennis', 5000, 'テニスコート'),
(1, 4, 'return', 'bus', NULL, 'バス移動（復路）');
```
