# 合宿費用計算アプリ 要件定義書

## 1. プロジェクト概要

### 1.1 目的
サークルの合宿における費用計算を自動化し、複雑な参加パターン（途中参加・途中抜け）に対応した精算金額を算出するWebアプリケーション。

### 1.2 背景
- 3泊4日の合宿で、途中参加・途中抜けが発生する
- 費用項目が多岐にわたり、手計算では煩雑
- 過去の合宿データを参照したい

---

## 2. ユーザー要件

### 2.1 利用者
| ロール | 人数 | 権限 |
|--------|------|------|
| 会計担当 | 2名 | 全機能利用可 |
| 幹事長 | 1名 | 全機能利用可 |

### 2.2 認証方式
- 簡易パスワード認証（共通パスワード）
- または個別アカウント（要検討）

---

## 3. 機能要件

### 3.1 合宿管理機能
- [ ] 合宿イベントの作成（名称、日程、泊数）
- [ ] 合宿一覧表示
- [ ] 過去合宿データの閲覧
- [ ] 合宿データの編集・削除
- [ ] **過去の合宿を複製して新規作成**

### 3.2 参加者管理機能
- [ ] 参加者の登録（氏名、学年、性別、参加パターン）
- [ ] 参加パターンの設定（下記参照）
- [ ] 参加者の編集・削除
- [ ] **CSVによる一括登録**（1列目:氏名、2列目:学年性別）
- [ ] **参加者一覧の検索・絞り込み**（名前で検索）
- [ ] **参加者一覧の並び替え**（名前順、学年順、性別順）

#### 3.2.1 参加者属性
| 属性 | 説明 | 値 |
|------|------|-----|
| 氏名 | 参加者の名前 | 文字列 |
| 学年 | 1〜4年生、OB/OG（0） | 0, 1, 2, 3, 4 |
| 性別 | 男性/女性 | male, female |

**OB/OGの区別**: grade=0の場合、性別で区別
- grade=0 + male = OB
- grade=0 + female = OG

#### 3.2.2 CSVインポート形式
```
山田太郎,1男
佐藤花子,2女
鈴木一郎,OB
高橋美咲,OG
```
- 1列目：氏名
- 2列目：学年性別（1男、1女、2男、2女、3男、3女、4男、4女、OB、OG）
- 全角数字（１男、２女など）にも対応
- 「1年男」「2年女」などの形式にも対応
- インポート時はデフォルトで全日程参加として登録（1日目往路バスから、最終日復路バスまで）
- 途中参加・途中抜けは登録後に個別設定

### 3.3 費用項目管理機能

#### 3.3.1 個人単位費用（参加日数に応じて発生）
| 項目 | 単位 | 備考 |
|------|------|------|
| 宿泊費 | 1泊あたり | 3食付き |
| 宴会場使用料 | 利用日あたり | 特定日のみ（日程で指定） |
| 保険料 | 1人あたり | 参加日数に関わらず固定 |

#### 3.3.2 全体割り勘費用（該当者で均等割り）
| 項目 | 割り勘対象 |
|------|------------|
| 大型バス（往復） | バス利用者（往復一括または往路/復路別設定） |
| 高速料金（往路） | 往路利用者 |
| 高速料金（復路） | 復路利用者 |
| レンタカー代 | レンタカー利用者（バス定員超過時のオプション） |
| レンタカー高速代 | レンタカー利用者 |
| コート/体育館代 | 該当コマ参加者（午前/午後単位） |
| その他雑費 | **項目ごとに対象者を指定** |

#### 3.3.3 バス料金の設定方式
- **往復一括設定**（デフォルト）：往復のバス代を一括で設定
- **往路/復路別設定**（オプション）：往路・復路それぞれの料金を個別設定

#### 3.3.4 レンタカーオプション
バスの定員を超過した場合に、追加でレンタカーを出すことが可能：
- レンタカー利用料金（総額）
- レンタカー高速代（総額）
- レンタカー定員（乗車可能人数）
- 参加者ごとにレンタカー利用を選択可能

#### 3.3.5 雑費の割り勘対象設定
雑費項目ごとに以下を設定可能：
- **全参加者**：途中参加含む全員
- **特定タイミング在籍者**：「何日目の何（午前/午後/夜）にいた人」を指定

### 3.4 食事管理機能（重要）

#### 3.4.1 宿泊サイクルの定義
```
【1泊のサイクル】
夕食 → 宿泊 → 翌朝食 → 翌昼食
```

#### 3.4.2 食事の追加・欠食パターン
| 参加タイミング | 食事への影響 |
|----------------|--------------|
| 昼食後から参加 | 変動なし（標準） |
| 昼食から参加 | 昼食代 **追加** |
| 夕食後から参加 | 夕食代 **欠食（減額）** |
| 昼食後に離脱 | 変動なし（標準） |
| 昼食前に離脱 | 昼食代 **欠食（減額）** |
| 朝食後に離脱 | 昼食代 **欠食（減額）** |

#### 3.4.3 食事単価設定（追加と欠食で金額が異なる）

| 食事 | 追加時 | 欠食時 | 備考 |
|------|--------|--------|------|
| 朝食 | +○○○円 | -○○○円 | 追加と欠食で金額が異なる |
| 昼食 | +990円 | -440円 | 例：前回実績 |
| 夕食 | +○○○円 | -○○○円 | 追加と欠食で金額が異なる |

**注意**: 宿泊費に含まれる食事を欠食する場合の減額と、宿泊サイクル外で追加する場合の加算額は異なる

### 3.5 計算機能
- [ ] 参加者ごとの負担額自動計算
- [ ] 費用内訳の表示
- [ ] 合計金額の集計

### 3.6 出力機能
- [ ] PDF出力（精算表）
- [ ] Excel出力（詳細データ、CSV形式）

#### 3.6.1 出力形式の詳細
- **フル参加者**（1日目往路バスから最終日復路バスまで参加）：1行にまとめて表示（負担額・内訳と対象者名のリスト）
- **途中参加・途中抜け**：個別に各人の参加期間・負担額・内訳を表示
- **途中参加・途中抜けスケジュール一覧**：各日のスロット（往路、午前、午後、宴会、復路）ごとに○×で参加状況を表示
  - 合計行には**全参加者（フル参加者含む）の中での参加人数**を表示

---

## 4. 参加パターンの設計

### 4.1 日程設計システム

合宿ごとに日程を柔軟に設定できるシステムとする。

#### タイムスロットの定義
各日は以下のタイムスロットで構成：

| スロット | 時間帯 | 設定可能な活動 |
|----------|--------|----------------|
| 往路 | 出発時 | バス移動 |
| 午前 | 9:00-12:00 | テニスコート / 体育館 / なし |
| 午後 | 13:00-17:00 | テニスコート / 体育館 / なし |
| 宴会 | 夕食後 | 宴会場利用 / なし |
| 復路 | 帰着時 | バス移動 |

#### 基本スケジュール（3泊4日）

```
【1日目】
  - [午前] バス移動（往路）
  - [昼食] 各自コンビニ等（費用計算対象外）
  - [午後] テニスコート
  - [夕食] 宿泊施設
  - [夜]   夜企画（宴会場使用、雑費発生）
  - [宿泊] あり

【2日目】
  - [朝食] 宿泊施設
  - [午前] テニスコート
  - [昼食] 宿泊施設
  - [午後] 体育館企画
  - [夕食] 宿泊施設
  - [夜]   （自由時間）
  - [宿泊] あり

【3日目】
  - [朝食] 宿泊施設
  - [午前] テニスコート
  - [昼食] 宿泊施設
  - [午後] テニスコート
  - [夕食] 宿泊施設
  - [夜]   （自由時間）
  - [宿泊] あり

【4日目】
  - [朝食] 宿泊施設
  - [午前] テニスコート
  - [昼食] 宿泊施設
  - [午後] バス移動（復路）
```

**注意**: 1日目の昼食は各自調達のため費用計算対象外

#### 施設料金の設定
日程設定時に、各コマに対して施設と料金を設定：
- 施設種別：テニスコート / 体育館 / その他
- 利用料金：コマごとに金額を入力

### 4.2 参加者ごとの設定項目
各参加者について以下を設定：

1. **基本情報**
   - 氏名
   - 学年（1年、2年、3年、OBOG）
   - 性別（男性/女性）

2. **参加期間**
   - 参加開始：何日目の何から（例：2日目昼食後）
   - 参加終了：何日目の何まで（例：4日目昼食後）

3. **交通手段**
   - 往路バス利用（する/しない）
   - 復路バス利用（する/しない）
   - レンタカー利用（する/しない）※レンタカーオプション有効時のみ

4. **自動計算される項目**
   - 宿泊数
   - コート利用コマ数
   - 食事の追加/欠食

---

## 5. 非機能要件

### 5.1 動作環境
- サーバー：お名前.com RSプラン
- 言語：PHP 7.4以上
- DB：MySQL 5.7
- 対応ブラウザ：Chrome, Safari, Edge（最新版）

### 5.2 セキュリティ
- HTTPS通信
- パスワード認証
- SQLインジェクション対策
- XSS対策

### 5.3 データ保持
- 過去の合宿データは無期限保持
- バックアップ：手動エクスポート機能で対応

---

## 6. 画面一覧（予定）

| No | 画面名 | 概要 |
|----|--------|------|
| 1 | ログイン画面 | 認証 |
| 2 | ダッシュボード | 合宿一覧、新規作成 |
| 3 | 合宿詳細画面 | 費用項目・参加者管理 |
| 4 | 参加者編集画面 | 参加パターン設定 |
| 5 | 計算結果画面 | 精算金額一覧 |
| 6 | 出力画面 | PDF/Excel出力 |

---

## 7. 決定事項

| 項目 | 決定内容 |
|------|----------|
| 保険料 | 参加日数に関わらず固定（1人1回） |
| 宴会場使用料 | 特定の日のみ発生（日程設定で指定） |
| コート代・体育館代 | 午前/午後のコマ単位で管理 |
| 雑費の割り勘 | 項目ごとに対象者を指定可能 |
| 雑費管理UI | 時間割形式でスロットをクリックして追加可能 |
| 認証方式 | 共通パスワード |
| 端数処理 | 四捨五入、差額は会計担当が調整 |
| 合宿複製 | 過去の合宿をコピーして新規作成可能 |
| バス料金 | 往復一括設定がデフォルト、往路/復路別設定もオプションで可能 |
| レンタカー | バス定員超過時のオプションとして利用可能 |
| 参加者属性 | 学年（1-4年、OB/OG）と性別を管理 |
| OB/OG区別 | grade=0で性別によりOB（男性）/OG（女性）を区別 |
| CSV取込 | 氏名・学年性別のCSVで一括登録可能（OB、OG対応、全角数字対応） |
| 参加デフォルト | 1日目は「往路バスから」、最終日は「復路バスまで」がデフォルト |
| 並び替え | 複合ソート対応（主キー・副キーを独立して設定可能） |
| 出力形式 | フル参加者は1行にまとめ、途中参加・途中抜けは個別表示 |

---

## 8. 用語定義

| 用語 | 定義 |
|------|------|
| 泊サイクル | 夕食→宿泊→翌朝食→翌昼食の1セット |
| 欠食 | 宿泊に含まれる食事を取らないこと（減額対象） |
| 追加食 | 宿泊サイクル外で食事を取ること（加算対象） |
| コマ | コート/体育館の利用単位（午前/午後） |
