# 合宿費用計算アプリ システム構成図

## 1. システム全体構成

```
┌─────────────────────────────────────────────────────────────────┐
│                        クライアント                              │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │
│  │    PC       │  │  タブレット  │  │ スマートフォン│            │
│  │  (Chrome)   │  │  (Safari)   │  │   (Chrome)   │            │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘            │
└─────────┼────────────────┼────────────────┼────────────────────┘
          │                │                │
          └────────────────┼────────────────┘
                           │ HTTPS
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│                  お名前.com RSプラン                             │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │                    Apache Web Server                       │ │
│  │  ┌─────────────────────────────────────────────────────┐  │ │
│  │  │                     PHP 7.4+                         │  │ │
│  │  │  ┌───────────────────────────────────────────────┐  │  │ │
│  │  │  │              アプリケーション                   │  │  │ │
│  │  │  │  ┌─────────┐ ┌─────────┐ ┌─────────────────┐ │  │  │ │
│  │  │  │  │ Router  │ │Controller│ │     Model       │ │  │  │ │
│  │  │  │  └────┬────┘ └────┬────┘ └────────┬────────┘ │  │  │ │
│  │  │  │       │           │                │          │  │  │ │
│  │  │  │       └───────────┴────────────────┘          │  │  │ │
│  │  │  └───────────────────────┬───────────────────────┘  │  │ │
│  │  └─────────────────────────┼───────────────────────────┘  │ │
│  └─────────────────────────────┼─────────────────────────────┘ │
│                                │                               │
│  ┌─────────────────────────────▼─────────────────────────────┐ │
│  │                      MySQL 5.7                            │ │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────────────┐ │ │
│  │  │  camps  │ │time_slots│ │participants│ │   expenses   │ │ │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────────────┘ │ │
│  └───────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

---

## 2. ディレクトリ構成

```
/public_html/
└── camp-calc/                    # アプリケーションルート
    │
    ├── index.php                 # エントリーポイント
    ├── .htaccess                 # URL書き換え設定
    │
    ├── config/
    │   ├── database.php          # DB接続設定
    │   └── app.php               # アプリ設定
    │
    ├── src/
    │   ├── Controllers/
    │   │   ├── AuthController.php
    │   │   ├── CampController.php
    │   │   ├── ParticipantController.php
    │   │   ├── TimeSlotController.php
    │   │   ├── ExpenseController.php
    │   │   └── CalculationController.php
    │   │
    │   ├── Models/
    │   │   ├── Camp.php
    │   │   ├── Participant.php
    │   │   ├── TimeSlot.php
    │   │   ├── ParticipantSlot.php
    │   │   ├── MealAdjustment.php
    │   │   └── Expense.php
    │   │
    │   ├── Services/
    │   │   ├── CalculationService.php   # 費用計算ロジック
    │   │   └── ExportService.php        # PDF/Excel出力
    │   │
    │   └── Core/
    │       ├── Database.php             # PDO wrapper
    │       ├── Router.php               # ルーティング
    │       ├── Session.php              # セッション管理
    │       └── Response.php             # レスポンス処理
    │
    ├── views/
    │   ├── layouts/
    │   │   └── main.php                 # 共通レイアウト
    │   │
    │   ├── auth/
    │   │   └── login.php
    │   │
    │   ├── camps/
    │   │   ├── index.php                # 一覧
    │   │   ├── create.php               # 新規作成
    │   │   └── detail.php               # 詳細（タブ）
    │   │
    │   ├── participants/
    │   │   └── _form.php                # 編集フォーム（モーダル）
    │   │
    │   ├── expenses/
    │   │   └── _form.php                # 編集フォーム（モーダル）
    │   │
    │   ├── results/
    │   │   ├── show.php                 # 計算結果
    │   │   └── partial-schedule.php     # 途参途抜一覧
    │   │
    │   └── guide.php                    # 使い方ガイド
    │
    ├── public/
    │   ├── css/
    │   │   └── style.css
    │   │
    │   └── js/
    │       ├── app.js                   # メインJS
    │       ├── participants.js          # 参加者管理
    │       └── calculation.js           # 計算表示
    │
    └── vendor/                          # ライブラリ（必要に応じて）
        └── ...
```

---

## 3. 技術スタック

### 3.1 サーバーサイド

| 項目 | 技術 | バージョン |
|------|------|------------|
| 言語 | PHP | 7.4以上 |
| データベース | MySQL | 5.7 |
| Webサーバー | Apache | RSプラン標準 |

### 3.2 フロントエンド

| 項目 | 技術 | 備考 |
|------|------|------|
| HTML | HTML5 | |
| CSS | CSS3 + Bootstrap 5 | レスポンシブ対応 |
| JavaScript | Vanilla JS | jQuery不使用（軽量化） |
| PDF出力 | TCPDF または mPDF | PHP製ライブラリ |
| Excel出力 | PhpSpreadsheet | PHP製ライブラリ |

---

## 4. API設計

### 4.1 エンドポイント一覧

| メソッド | パス | 説明 |
|----------|------|------|
| POST | /api/auth/login | ログイン |
| POST | /api/auth/logout | ログアウト |
| GET | /api/camps | 合宿一覧取得 |
| POST | /api/camps | 合宿新規作成 |
| GET | /api/camps/{id} | 合宿詳細取得 |
| PUT | /api/camps/{id} | 合宿更新 |
| DELETE | /api/camps/{id} | 合宿削除 |
| POST | /api/camps/{id}/duplicate | **合宿複製**（日程・費用設定をコピー） |
| GET | /api/camps/{id}/time-slots | タイムスロット取得 |
| PUT | /api/camps/{id}/time-slots | タイムスロット一括更新 |
| GET | /api/camps/{id}/participants | 参加者一覧取得 |
| POST | /api/camps/{id}/participants | 参加者追加 |
| POST | /api/camps/{id}/participants/import | **参加者CSV一括登録** |
| PUT | /api/participants/{id} | 参加者更新 |
| DELETE | /api/participants/{id} | 参加者削除 |
| GET | /api/camps/{id}/expenses | 雑費一覧取得 |
| POST | /api/camps/{id}/expenses | 雑費追加 |
| PUT | /api/expenses/{id} | 雑費更新 |
| DELETE | /api/expenses/{id} | 雑費削除 |
| GET | /api/camps/{id}/calculate | 費用計算実行 |
| GET | /api/camps/{id}/partial-schedule | **途参途抜スケジュール取得** |
| GET | /api/camps/{id}/export/pdf | PDF出力 |
| GET | /api/camps/{id}/export/excel | Excel出力 |

**ページルート（HTML表示）**

| メソッド | パス | 説明 |
|----------|------|------|
| GET | / | トップページ（リダイレクト） |
| GET | /login | ログイン画面 |
| GET | /camps | 合宿一覧（ダッシュボード） |
| GET | /camps/{id} | 合宿詳細画面 |
| GET | /camps/{id}/result | 計算結果画面 |
| GET | /camps/{id}/partial-schedule | 途参途抜一覧画面 |
| GET | /guide | **使い方ガイド画面** |

### 4.2 レスポンス形式

```json
// 成功時
{
  "success": true,
  "data": { ... }
}

// エラー時
{
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "入力内容に誤りがあります",
    "details": { ... }
  }
}
```

---

## 5. セキュリティ設計

### 5.1 認証・認可

```
┌─────────────────────────────────────────────────────────────┐
│                      認証フロー                              │
│                                                             │
│  ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐ │
│  │ログイン │───→│パスワード│───→│セッション│───→│ 認証済み │ │
│  │ フォーム │    │  照合   │    │  発行   │    │  状態   │ │
│  └─────────┘    └─────────┘    └─────────┘    └─────────┘ │
│                                                             │
│  - パスワードはハッシュ化して保存（password_hash）          │
│  - セッションは24時間で有効期限切れ                         │
│  - CSRFトークンで不正リクエスト防止                         │
└─────────────────────────────────────────────────────────────┘
```

### 5.2 入力検証

| 対策 | 実装方法 |
|------|----------|
| SQLインジェクション | PDO prepared statements |
| XSS | htmlspecialchars() でエスケープ |
| CSRF | セッショントークン検証 |

---

## 6. 計算ロジック詳細

### 6.1 処理フロー

```
┌─────────────────────────────────────────────────────────────┐
│                     費用計算フロー                           │
│                                                             │
│  ┌─────────┐    ┌─────────────┐    ┌─────────────────────┐ │
│  │合宿データ│───→│参加者ループ │───→│  個人費用計算        │ │
│  │  取得   │    │            │    │  - 宿泊費            │ │
│  └─────────┘    └─────────────┘    │  - 保険料            │ │
│                       │           │  - 宴会場            │ │
│                       │           │  - 食事調整          │ │
│                       │           └─────────────────────┘ │
│                       │                     │              │
│                       │                     ▼              │
│                       │           ┌─────────────────────┐ │
│                       │           │  割り勘費用計算      │ │
│                       │           │  - バス（往/復）     │ │
│                       │           │  - 高速（往/復）     │ │
│                       │           │  - 施設費（コマ別）  │ │
│                       │           │  - 雑費              │ │
│                       │           └─────────────────────┘ │
│                       │                     │              │
│                       │                     ▼              │
│                       │           ┌─────────────────────┐ │
│                       └──────────→│    合計算出          │ │
│                                   └─────────────────────┘ │
│                                             │              │
│                                             ▼              │
│                                   ┌─────────────────────┐ │
│                                   │   結果返却           │ │
│                                   └─────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### 6.2 計算式

```php
// 参加者ごとの負担額計算（疑似コード）
function calculateParticipantFee($participant, $camp) {
    $total = 0;

    // 1. 宿泊費
    $nights = $participant->leave_day - $participant->join_day;
    $total += $camp->lodging_fee_per_night * $nights;

    // 2. 保険料（固定）
    $total += $camp->insurance_fee;

    // 3. 宴会場使用料
    foreach ($banquetSlots as $slot) {
        if ($participant->isAttending($slot)) {
            $attendees = countAttendees($slot);
            $total += $slot->facility_fee / $attendees;
        }
    }

    // 4. 食事調整
    $total += calculateMealAdjustment($participant, $camp);

    // 5. バス代（往復一括 or 往路/復路別）
    if ($camp->bus_fee_separate) {
        // 往路/復路別設定
        if ($participant->use_outbound_bus) {
            $outboundUsers = countOutboundBusUsers($camp);
            $total += $camp->bus_fee_outbound / $outboundUsers;
            $total += $camp->highway_fee_outbound / $outboundUsers;
        }
        if ($participant->use_return_bus) {
            $returnUsers = countReturnBusUsers($camp);
            $total += $camp->bus_fee_return / $returnUsers;
            $total += $camp->highway_fee_return / $returnUsers;
        }
    } else {
        // 往復一括設定
        if ($participant->use_outbound_bus && $participant->use_return_bus) {
            $roundTripUsers = countRoundTripBusUsers($camp);
            $total += $camp->bus_fee_round_trip / $roundTripUsers;
        } elseif ($participant->use_outbound_bus) {
            $outboundOnlyUsers = countOutboundOnlyUsers($camp);
            $total += ($camp->bus_fee_round_trip / 2) / $outboundOnlyUsers;
        } elseif ($participant->use_return_bus) {
            $returnOnlyUsers = countReturnOnlyUsers($camp);
            $total += ($camp->bus_fee_round_trip / 2) / $returnOnlyUsers;
        }
        // 高速代
        if ($participant->use_outbound_bus) {
            $total += $camp->highway_fee_outbound / countOutboundBusUsers($camp);
        }
        if ($participant->use_return_bus) {
            $total += $camp->highway_fee_return / countReturnBusUsers($camp);
        }
    }

    // 6. レンタカー（オプション有効時）
    if ($camp->use_rental_car && $participant->use_rental_car) {
        $rentalCarUsers = countRentalCarUsers($camp);
        $total += $camp->rental_car_fee / $rentalCarUsers;
        $total += $camp->rental_car_highway_fee / $rentalCarUsers;
    }

    // 7. 施設利用料（コマ別）
    foreach ($facilitySlots as $slot) {
        if ($participant->isAttending($slot)) {
            $attendees = countAttendees($slot);
            $total += $slot->facility_fee / $attendees;
        }
    }

    // 8. 雑費
    foreach ($expenses as $expense) {
        if ($expense->isTargetParticipant($participant)) {
            $targets = countExpenseTargets($expense);
            $total += $expense->amount / $targets;
        }
    }

    return round($total); // 端数処理
}
```

---

## 7. 開発・デプロイフロー

```
┌─────────────────────────────────────────────────────────────┐
│                    開発フロー                                │
│                                                             │
│  ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐ │
│  │ローカル │───→│  テスト │───→│  FTP    │───→│  本番   │ │
│  │  開発  │    │        │    │アップロード│    │ サーバー │ │
│  └─────────┘    └─────────┘    └─────────┘    └─────────┘ │
│                                                             │
│  ローカル環境: XAMPP / MAMP                                 │
│  デプロイ: FileZilla等でFTPアップロード                     │
└─────────────────────────────────────────────────────────────┘
```

---

## 8. 端数処理方針

| 項目 | 処理方法 |
|------|----------|
| 割り勘計算 | 四捨五入（round） |
| 端数の扱い | 最後の1人に調整分を加算 or 会計担当が負担 |
| 表示 | 円単位（小数点以下なし） |
