# 合宿費用計算アプリ - Claude Code 指示書

## プロジェクト概要
サークルの合宿における費用計算を自動化するWebアプリケーション。
お名前.com RSプランでホスティング。

## 技術スタック
- PHP 7.4+
- MySQL 5.7
- Bootstrap 5
- Vanilla JavaScript

## ディレクトリ構成
```
src/
├── index.php          # エントリーポイント
├── config/            # 設定ファイル
├── src/
│   ├── Controllers/   # コントローラー
│   ├── Models/        # モデル
│   ├── Services/      # サービス
│   └── Core/          # フレームワークコア
├── views/             # ビュー（PHP）
├── public/            # 静的ファイル
└── database/          # SQLファイル
```

## 重要なルール

### 設計書の更新
**機能追加や変更を行った際は、必ず以下の設計書に変更内容を反映すること：**

1. `docs/01_要件定義書.md` - 機能要件・決定事項
2. `docs/02_データベース設計書.md` - テーブル定義・計算ロジック
3. `docs/03_画面設計書.md` - UI設計・モーダル
4. `docs/04_システム構成図.md` - APIエンドポイント・処理フロー

### コーディング規約
- PHP: PSR-4準拠のオートロード
- 関数の重複定義を避けるため `function_exists()` でラップ
- SQLインジェクション対策: PDO prepared statements使用
- XSS対策: `htmlspecialchars()` でエスケープ

### データベース
- 新規カラム追加時は `database/` 配下にマイグレーションSQLを作成
- 既存テーブルの変更は `migration_*.sql` として保存

## 最近の主要な変更履歴

### バス料金・レンタカー機能（2024年）
- バス料金を往復一括設定（デフォルト）に変更
- 往路/復路別設定をオプション化
- レンタカーオプション追加（バス定員超過時用）

### 参加者管理機能強化
- 学年・性別フィールド追加
- CSVインポート機能追加（形式: 氏名,学年性別）
- 検索・並び替え機能追加

### OB/OG区別機能（2025年1月）
- OBとOGを区別して表示（grade=0 + 性別で判定）
- CSVインポートで「OB」「OG」を個別に認識
- 表示: 男性OB→「OB」、女性OG→「OG」

### 雑費の時間割UI（2025年1月）
- 時間割形式のグリッドで雑費を視覚的に管理
- マスをクリックして特定タイミングの参加者対象の雑費を追加
- 既存雑費はマス内に表示、クリックで編集

### 日程設定タブの編集機能（2025年1月）
- 各スロット（午前/午後/宴会）の施設種別と料金を編集可能に
- 施設種別: テニスコート、体育館、宴会場、その他、なし
- 宴会スロットがない日には追加ボタンを表示

### 雑費の建て替え者機能（2025年1月）
- 雑費に建て替え者（payer_id）を登録可能に
- 参加者一覧からドロップダウンで選択
- 雑費一覧・時間割UIで建て替え者を表示
- 建て替え総額の集計表示（人ごとの総額と内訳）

### コート・体育館料金の単価管理（2025年1月）
- 合宿作成時にコート1面あたり料金を設定
- 合宿作成時に体育館1コマあたり料金を設定
- 日程設定で各スロットの使用コート面数を指定
- テニスコートの場合は面数×単価で自動計算
- 体育館の場合は1コマ単価で自動計算

### 基本情報編集機能（2025年1月）
- 合宿詳細画面の基本情報タブに編集ボタンを追加
- 合宿名、コート単価、宿泊費用、食事単価、交通費を編集可能
- バス代の往復/別設定切り替え、レンタカーの有効/無効切り替え対応
- 日程（開始日/終了日/泊数）は参加者・スケジュールに影響するため編集不可

### 宴会場料金の単価管理（2025年1月）
- 合宿作成時に宴会場1人あたり料金（banquet_fee_per_person）を設定
- 基本情報編集で宴会場単価を編集可能
- 日程設定で施設種別「宴会場」を選択すると1人あたり単価が自動適用
- 小計には「¥X/人」の形式で表示（総額ではなく参加者ごとの単価）

## デプロイ
- FTPでアップロード（FileZilla推奨）
- `.htaccess` のアップロードを忘れずに
